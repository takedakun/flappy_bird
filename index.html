<canvas id="flappy" width="300" height="400"></canvas>
<script>
	window.onload = function(){
		canv = document.getElementById("flappy");
		context = canv.getContext("2d");
		set_canvas(context);
		timer = setInterval(game, frame_rate);
		document.addEventListener("keydown", keyPush);
		//setInterval(game, 10);
	}

	var bird;
	var pipes = [];
	var rest_lives = 5;
	var rest_lives_prev = rest_lives;
	var score_flag=0;
	var score = 0;
	var speed_up_flag = 0;
	var frame_count = 0;
	var frame_state = 0;
	var frame_rate = 30;
	var happy_face = new Image();
	var sad_face = new Image();
	var back = new Image();
	var pillar = new Image();
	happy_face.src = "image/nikori.png";
	sad_face.src = "image/turai.png";
	back.src = "image/back.jpg";
	pillar.src = "image/pillar.jpg";

	function Pipe(){
		this.x = canv.width;
		this.top_y = Math.random()*(canv.height/2-15);
		this.bottom_y = Math.random()*(canv.height/2-15);
		this.xv = 5;

		this.draw = function() {
			context.fillStyle="white";
			context.fillRect(this.x, 0, 15, this.top_y);
			context.fillRect(this.x, canv.height-this.bottom_y, 15, this.bottom_y);
			//context.drawImage(pillar, this.x, 0, 15, this.top_y)
		}
		this.update = function() {
			this.x -= this.xv
		}

		this.contact = function(bird) {
			var prev_frame_state = frame_state;
			//bird contact pipe or not
			if ( bird.x - 25 < this.x && this.x < bird.x + 10 ){
				if ( bird.y-10 < this.top_y ) {
					context.drawImage(sad_face, bird.x-10, bird.y-10, 20, 20);
					context.fillStyle="red";
					context.fillRect(this.x, 0, 15, this.top_y);
					frame_state = 1;
				}else if (bird.y+10 > canv.height-this.bottom_y){
					context.drawImage(sad_face, bird.x-10, bird.y-10, 20, 20);
					context.fillStyle="red";
					context.fillRect(this.x, canv.height-this.bottom_y, 15, this.bottom_y);
					frame_state = 1;
				} else {
					frame_state = 0;
				}
			} else {
				frame_state = 0;
			}
			//compare rest_lives with rest_lives_prev
			if ( this.x <= bird.x - 25 ) {
				if ( score_flag == 0 ) {
					score_flag = 1;
					if (rest_lives == rest_lives_prev) {
							score += 10;
							if (score != 0 && score%100==0) {
								speed_up_flag = 0;
							}
					} else {
						rest_lives_prev = rest_lives;
					}
				}
			} else {
				score_flag = 0
			}
			//manage rest_lives
			if (prev_frame_state==0 && frame_state==1 ) {
				rest_lives_prev = rest_lives;
				rest_lives -=1;
			}
			if (rest_lives <= 0) {
				rest_lives = 5;
				frame_rate = 30;
				clearInterval(timer);
				timer = setInterval(game, frame_rate);
				window.location.replace("gameover.html?score="+score);
				console.log("game over");
			}
		}
	}

	function Bird() {
			this.x = 70;
			this.y = 100;
			this.gravity = 0.7;
			this.velocity = 0;
			this.draw = function () {
				context.drawImage(happy_face, this.x-10, this.y-10, 20, 20);
			}
			this.update = function () {
				if (this.y < canv.height-10 && this.y > 10) {
					this.y += this.velocity;
					this.velocity += this.gravity;
				}else if ( this.y >= canv.height-10 ) {
					this.y = canv.height-10;
					this.velocity = 0;
				}else if (this.y <= 10){
					this.velocity = 0.5*Math.abs(this.velocity);
					this.y += this.velocity;
					this.velocity += this.gravity;
				}
			}
			this.jump = function () {
				this.velocity = -8;
				if ( this.y >= canv.height-10 ) {
					this.y += this.velocity;
					this.velocity += this.gravity
				}
			}
	}

	function set_canvas(context) {
		context.drawImage(back, 0, 0, 300, 600);
		bird = new Bird();
		pipe = new Pipe();
		pipes.push(pipe);
	}

	function game () {
		frame_count += 1;
		context.drawImage(back, 0, 0, 300, 400);
		//display rest lives
		for (var i =0; i < rest_lives; i++) {
			context.drawImage(happy_face, canv.width-(i+1)*20, 10, 20, 20);
		}
		//display score
		context.font = "20px Arial";
		context.textAlign = "right";
		context.fillText(score, canv.width-10, 50);
		//speed up according to score
		if ( score!=0 && score%100==0 && speed_up_flag==0) {
			if ( frame_rate >=4 ) {
				frame_rate-=3;
			} else {
				frame_rate = frame_rate
			}
			speed_up_flag = 1;
			console.log(frame_rate);
			clearInterval(timer);
			timer = setInterval(game, frame_rate);
		}
		//display bird
		bird.update();
		bird.draw();
		//display pipes
		if (frame_count%40==0){
			pipes.push(new Pipe());
		}
		for ( var i=0; i<pipes.length; i++ ) {
			if (pipes[i].x < -15){
				pipes.splice(0, 1)
			}
			pipes[i].update();
			pipes[i].draw();
		}
		pipes[0].contact(bird);
	}

	function keyPush(evt){
		console.log(evt.keyCode);
		if (evt.keyCode!=13) {
				bird.jump();
		}
	}

</script>
